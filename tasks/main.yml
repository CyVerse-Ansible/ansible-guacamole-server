---

- name: Gather OS-specific variables
  include_vars: "{{ ansible_distribution }}.yml"
  tags: vars

- tags: install
  block:
  - name: Install dependencies for guacamole
    package: name={{ item }} state=latest
    with_items: '{{ PACKAGES }}'
  - name: install libvncserver
    package: name=libvncserver-dev state=latest
  - name: Copy over guacamole-server source
    copy: src="files/guacamole-server-0.9.9.tar.gz" dest=/tmp/
  - name: Extract the guacamole-server source
    unarchive: src="/tmp/guacamole-server-0.9.9.tar.gz" copy=no dest="/tmp/"
  - name: Build guacamole-server from source
    shell: '{{ item }}'
    args:
      chdir: /tmp/guacamole-server-0.9.9
      creates: /usr/local/sbin/guacd
    with_items: [ ./configure --with-init-dir=/etc/init.d, make, make install ]
  - name: Run ldconfig so that guacd can run correctly
    shell: ldconfig
  - name: Download guacamole-auth-hmac source
    git: clone=yes dest=/tmp/guacamole-auth-hmac repo=https://github.com/calvinmclean/guacamole-auth-hmac.git force=yes
  - name: Build the jar
    shell: mvn package chdir=/tmp/guacamole-auth-hmac
  - name: Make '{{ GUACAMOLE_HOME }}' directory
    file: path='{{ GUACAMOLE_HOME }}' state=directory
  - name: Make '{{ GUACAMOLE_HOME }}'/extensions directory
    file: path='{{ GUACAMOLE_HOME }}/extensions' state=directory
  - name: Copy over guacamole-0.9.9.war
    copy: src="files/guacamole-0.9.9.war" dest=/var/lib/tomcat7/webapps/guacamole.war
  - name: Move guacamole-auth-hmac.jar to extensions directory
    copy: src="/tmp/guacamole-auth-hmac/target/guacamole-auth-hmac-1.0.jar" dest='{{ GUACAMOLE_HOME }}/extensions/guacamole-auth-hmac.jar' remote_src=yes

- tags: template
  block:
  - name: Add guacamole.properties to "{{ GUACAMOLE_HOME }}"
    template: src="guacamole.properties.j2" dest="{{ GUACAMOLE_HOME }}/guacamole.properties"
  - name: Add CorsFilter to tomcat7's guacamole directory /var/lib/tomcat7/webapps/guacamole/WEB-INF/web.xml
    blockinfile:
      dest: "/var/lib/tomcat7/webapps/guacamole/WEB-INF/web.xml"
      insertafter: "<!-- Basic config -->"
      state: present
      block: |
        <filter>
          <filter-name>CorsFilter</filter-name>
          <filter-class>org.apache.catalina.filters.CorsFilter</filter-class>
          <init-param>
              <param-name>cors.allowed.origins</param-name>
              <param-value>*</param-value>
          </init-param>
          <init-param>
              <param-name>cors.allowed.methods</param-name>
              <param-value>GET,POST,HEAD,OPTIONS,OPTIONS,PUT</param-value>
          </init-param>
          <init-param>
              <param-name>cors.allowed.headers</param-name>
              <param-value>Content-Type,X-Requested-With,accept,Origin,Access-Control-Request-Method,Access-Control-Request-Headers</param-value>
          </init-param>
          <init-param>
              <param-name>cors.exposed.headers</param-name>
              <param-value>Access-Control-Allow-Origin,Access-Control-Allow-Credentials</param-value>
          </init-param>
        </filter>
        <filter-mapping>
          <filter-name>CorsFilter</filter-name>
          <url-pattern>/*</url-pattern>
        </filter-mapping>

- name: Cleanup temp files
  file: path={{ item }} state=absent
  with_items:
    - /tmp/guacamole-server-0.9.9.tar.gz
    - /tmp/guacamole-server-0.9.9
    - /tmp/guacamole-auth-hmac
  ignore_errors: yes
  tags: cleanup

- name: restart services (tomcat,guacd)
  service: name={{ item }} state=restarted
  with_items: [ tomcat7, guacd ]
  ignore_errors: yes
  tags: restart
